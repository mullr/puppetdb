<!DOCTYPE html>
<meta charset="utf-8">
<title>PuppetDB: Dashboard</title>

<style>
@import url(https://fonts.googleapis.com/css?family=Lato:400,700);

body {
  background-color: white;
  font-family: 'Lato', sans-serif;
}

.x.axis line {
  shape-rendering: auto;
}

.line {
  fill: #edf7ff;
  stroke: #43a2ca;
  stroke-width: 1.5px;
}

#metrics {
  cell-spacing: 0px;
  cell-padding: 0px;
  border-collapse: collapse;
}

#metrics td {
  margin: 0px;
  padding: 0px 10px;
}

#metrics tr {
  border-bottom: 2px solid #eee;
}

.counterbox {
  text-align: center;
}

.counterdesc {
  font-size: 20px;
  color: #ef8a62;
  text-align: right;
  font-weight: 700;
}

.counteraddendum {
  font-size: 15px;
  height: 100%;
  color: #666;
  text-align: right;
}

.countertext {
  font-size: 50px;
  color: #43a2ca;
  height: 65px;
}

.countertimescale {
  color: #999;
  font-variant: small-caps;
}

.axis {
  font-size: 10px;
  color: #999;
}

.axis path, .axis line {
  fill: none;
  stroke: #999;
}

.hidden {
  display: none;
}

#version-info {
  font-size: 15px;
  color: #666;
  float: right;
}

#update-link {
  color: blue;
}
</style>

<script src="d3.v2.js"></script>
<script src="charts.js"></script>

<div id="version-info">
  PuppetDB <span id="version">(unknown version)</span>
  <a id="update-link" href="#" class="hidden">(<span id="latest-version"></span> is available!)</a>
</div>

<table id="metrics">
</table>

<script>(function() {
  // Formatting middleware that collapses small values to 0
  function clampToZero(f, window) {
    return function(n) {
      return f(Math.abs(n) < window ? 0 : n);
    };
  };

  // Parse URL arguments
  function getParameter(paramName) {
    var searchString = window.location.search.substring(1),
        i, val, params = searchString.split("&");

    for (i=0;i<params.length;i++) {
      val = params[i].split("=");
      if (val[0] == paramName) {
        return unescape(val[1]);
      }
    }
    return null;
  };

  function setVersion() {
    d3.json("/pdb/query/v4/version", function (res) {
      if (res != null && res.version != null) {
        d3.select('#version').html('v' + res.version);
      }
      else {
        d3.select('#version').html('(unknown version)');
      }
    });
  };

  function checkForUpdates() {
    d3.json("/pdb/query/v4/version/latest", function (res) {
      console.log(res);
      if (res != null && res.newer) {
        d3.select('#latest-version').html('v' + res.version);
        d3.select('#update-link').classed('hidden', false);
        if (res.link) {
          d3.select('#update-link').property('href', res.link);
        }
      }
      else {
        d3.select('#update-link').classed('hidden', true);
      }
    });
  };

  var nHistorical = getParameter("nHistorical") || 60;
  var pollingInterval = getParameter("pollingInterval") || 5000;
  var width = getParameter("width") || 400;
  var height = getParameter("height") || 60;

  var metrics = [
    { mbean: "java.lang:type=Memory",
      dataPath: ["HeapMemoryUsage", "used"],
      format: ",.3s",
      description: "JVM Heap",
      addendum: "bytes" },
   
    { mbean: "puppetlabs.puppetdb.query.population:type=default,name=num-nodes",
      dataPath: ["Value"],
      format: ",",
      description: "Nodes",
      addendum: "in the population" },
   
    { mbean: "puppetlabs.puppetdb.query.population:type=default,name=num-resources",
      dataPath: ["Value"],
      format: ",",
      description: "Resources",
      addendum: "in the population" },
   
    { mbean: "puppetlabs.puppetdb.query.population:type=default,name=pct-resource-dupes",
      dataPath: ["Value"],
      format: ",.1%",
      description: "Resource duplication",
      addendum: "% of resources stored" },
   
    { mbean: "puppetlabs.puppetdb.scf.storage:type=default,name=duplicate-pct",
      dataPath: ["Value"],
      format: ",.1%",
      description: "Catalog duplication",
      addendum: "% of catalogs encountered" },
   
    { mbean: "org.apache.activemq:type=Broker,brokerName=localhost,destinationType=Queue,destinationName=puppetlabs.puppetdb.commands",
      dataPath: ["QueueSize"],
      format: ",s",
      description: "Command Queue",
      addendum: "depth" },
   
    { mbean: "puppetlabs.puppetdb.command:type=global,name=processing-time",
      dataPath: ["50thPercentile"],
      scale: 0.001,
      format: ",.3s",
      description: "Command Processing",
      addendum: "sec/command" },
   
    { mbean: "puppetlabs.puppetdb.command:type=global,name=processed",
      dataPath: ["FiveMinuteRate"],
      format: ",.3s",
      clampToZero: 0.001,
      description: "Command Processing",
      addendum: "commands/sec" },
   
    { mbean: "puppetlabs.puppetdb.command:type=global,name=processed",
      dataPath: ["Count"],
      format: ",",
      description: "Processed",
      addendum: "since startup" },
   
    { mbean: "puppetlabs.puppetdb.command:type=global,name=retried",
      dataPath: ["Count"],
      format: ",",
      description: "Retried",
      addendum: "since startup" },
   
    { mbean: "puppetlabs.puppetdb.command:type=global,name=discarded",
      dataPath: ["Count"],
      format: ",",
      description: "Discarded",
      addendum: "since startup" },
   
    { mbean: "puppetlabs.puppetdb.command:type=global,name=fatal",
      dataPath: ["Count"],
      format: ",",
      description: "Rejected",
      addendum: "since startup" },
   
    { mbean: "puppetlabs.puppetdb.http.command:type=/pdb/cmd/v1,name=service-time",
      dataPath: ["50thPercentile"],
      scale: 0.001,
      format: ",.3s",
      description: "Enqueueing",
      addendum: "service time, seconds" },
   
    { mbean: "puppetlabs.puppetdb.http.server:type=/pdb/query/v4/resources,name=service-time",
      dataPath: ["50thPercentile"],
      scale: 0.001,
      format: ",.3s",
      description: "Collection Queries",
      addendum: "service time, seconds" },
   
    { mbean: "puppetlabs.puppetdb.scf.storage:type=default,name=gc-time",
      dataPath: ["50thPercentile"],
      scale: 0.001,
      format: ",.3s",
      description: "DB Compaction",
      addendum: "round trip time, seconds" },
   
    { mbean: "puppetlabs.puppetdb.command.dlo:type=global,name=compression",
      dataPath: ["50thPercentile"],
      scale: 0.001,
      format: ",.3s",
      description: "DLO Compression",
      addendum: "round trip time, seconds" },
   
    { mbean: "puppetlabs.puppetdb.command.dlo:type=global,name=filesize",
      dataPath: ["Value"],
      format: ",.3s",
      description: "DLO Size on Disk",
      addendum: "bytes" },
   
    { mbean: "puppetlabs.puppetdb.command.dlo:type=global,name=messages",
      dataPath: ["Value"],
      format: ",",
      description: "Discarded Messages",
      addendum: "to be reviewed" }
  ];

  function getIn(o, path) {
    if(path.length === 0) {
      return o;
    } else {
      return getIn(o[path[0]], path.slice(1));
    }
  }

  metrics.map( function(m) {
    var format = d3.format(m.format);
    if(typeof(m.clampToZero) != 'undefined') {
      format = clampToZero(format, m.clampToZero);
    }

    counterAndSparkline()
      .url("/metrics/v1/mbeans/" + m.mbean)
      .snag(function(res) {
              var val = getIn(res, m.dataPath);
              if(typeof(m.scale) !== 'undefined') {
                val = val * m.scale;
              }
              return val;
            })
      .format(format)
      .description(m.description)
      .addendum(m.addendum)
      .container("#metrics")
      .nHistorical(nHistorical)
      .pollingInterval(pollingInterval)
      .width(width)
      .height(height)
      .call();
  });

  // Check the current version and for updates now, and then every 5 minutes
  setVersion();
  checkForUpdates();
  setInterval(setVersion, 5*60*1000);
  setInterval(checkForUpdates, 5*60*1000);
})()</script>

